apply plugin: 'groovy'
apply plugin: 'jacoco'

dependencies {
    compile gradleApi()
    compile localGroovy()
    compile project(':base:gradle')
    testCompile "org.jacoco:org.jacoco.agent:0.7.1.201405082137"
}

test {
    environment("PROJECT_BUILD_DIR", project.buildDir)

    description =
            "Runs the project integration tests. This requires an SDK either from the Android " +
                    "source tree, under out/..., or an env var ANDROID_HOME."
    systemProperties['jar.path'] = jar.archivePath
    environment("CUSTOM_REPO", rootProject.file("../out/repo"))

    forkEvery = 1
    maxParallelForks = Runtime.runtime.availableProcessors() / 2

    useJUnit {
        excludeCategories "com.android.build.gradle.integration.common.category.DeviceTests"
    }
}

task connectedIntegrationTest(type: Test) {
    environment("PROJECT_BUILD_DIR", project.buildDir)

    testClassesDir = sourceSets.test.output.classesDir
    classpath = sourceSets.test.runtimeClasspath
    description =
            "Runs the project integration tests with device tests. This requires an SDK either " +
                    "from the Android source tree, under out/..., or an env var ANDROID_HOME " +
                    "and a device."
    group = "verification"
    systemProperties['jar.path'] = jar.archivePath
    environment("CUSTOM_REPO", rootProject.file("../out/repo"))
}

test.dependsOn ':publishLocal'
connectedIntegrationTest.dependsOn ':publishLocal'

jacocoTestReport {
    sourceSets project(':base:gradle').sourceSets.main
    sourceSets project(':base:builder').sourceSets.main
    sourceSets project(':base:builder-model').sourceSets.main
}
